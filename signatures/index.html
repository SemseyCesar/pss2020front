<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
  <head>
    <meta charset="utf-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">



    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,600" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <!-- Button icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  </head>
  <body>
    <div class="container mt-4 mb-4">
      <div class="card">
        <!-- Card header -->
        <div class="card-header h2">
          Buscar Materia
        </div>

        <!-- Card body  -->
        <div class="card-body">

            <div class="row mb-4 justify-content-center">

                  <div class="col">
                    <select class="custom-select" name="selecTypeSearch" id="selecTypeSearch" required>
                      <option value="">Buscar por...</option>
                      <option value="name">Nombre</option>
                      <option value="code">Codigo</option>
                    </select>
                    <div class="invalid-feedback">
                      Seleccione una opci贸n.
                    </div>
                  </div>
                  
                  <div class="col-md">
                    <input class="form-control" type="text" name="searchValue" id="searchValue" placeholder="Seleccione una opci贸n">
                  </div>
                  
                  <div class="col">
                    <button class="btn btn-primary" id="btnBuscar" name="search">
                      <i class="fa fa-search"></i>
                      Buscar
                    </button>
                  </div>

                  <div class="col">
                    <button class="btn btn-success" id="btnAgregarMateria" name="add">
                      <i class="fa fa-plus"></i>
                      Agregar materia
                    </button>
                  </div>
                  
              </div>


            <div class="row">
              <table class="table">
                <thead class="thead-light">
                  <tr>
                    <th scope="col">Codigo</th>
                    <th scope="col">Nombre</th>
                    <th scope="col">Departamento</th>
                    <th scope="col">Modificar</th>
                    <th scope="col">Eliminar</th>
                  </tr>
                </thead>
                <tbody id="signatureList">
                </tbody>
              </table>
          </div>
      </div>
      
      <div class="card-footer text-right">
        <b id="footer"></b>
      </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      const selectElement = document.getElementById('selecTypeSearch');
      selectElement.addEventListener('change', (event) => {
        const searchText = document.getElementById('searchValue');
        document.getElementById("selecTypeSearch").setAttribute("class", "custom-select");
        if (event.target.value == "name") {
          searchText.placeholder = "Ingrese el Nombre";
        }
        else {
          if (event.target.value == "code") {
            searchText.placeholder = "Ingrese el Codigo";
          } else {
            searchText.placeholder = "Seleccione una opci贸n";
            document.getElementById("selecTypeSearch").setAttribute("class", "custom-select is-invalid");
          }
        }
      });

      function createItem(data){
        let fila = document.createElement("tr");
        let celda_identificador = document.createElement("td");
        let celda_nombre = document.createElement("td");
        let celda_departamento = document.createElement("td");
        let celda_boton_modificar = document.createElement("td");
        let celda_boton_borrar = document.createElement("td");
        
        let boton_modificar = document.createElement("button");
        let boton_borrar = document.createElement("button");
        let icon_modificar = document.createElement("i");
        let icon_borrar = document.createElement("i");
        icon_modificar.setAttribute("class", "fa fa-edit");
        icon_borrar.setAttribute("class", "fa fa-trash");
        boton_modificar.setAttribute("class", "btn btn-outline-warning");
        boton_modificar.setAttribute("id", ""+data['identificador']);
        boton_modificar.addEventListener('click', (event) => {
          document.getElementById('footer').innerHTML = event.target.id;
        })
        boton_borrar.setAttribute("class", "btn btn-outline-danger");
        boton_modificar.appendChild(icon_modificar);
        boton_borrar.appendChild(icon_borrar);

        celda_identificador.appendChild(document.createTextNode(""+data['identificador']));
        celda_nombre.appendChild(document.createTextNode(""+data['nombre']));
        celda_departamento.appendChild(document.createTextNode(""+data['dpto']));
        celda_boton_modificar.appendChild(boton_modificar);
        celda_boton_borrar.appendChild(boton_borrar);

        fila.appendChild(celda_identificador);
        fila.appendChild(celda_nombre);
        fila.appendChild(celda_departamento);
        fila.appendChild(celda_boton_modificar);
        fila.appendChild(celda_boton_borrar);

        return fila;
      }


      let btnBuscar = document.getElementById('btnBuscar');
      btnBuscar.addEventListener('click', (event) =>{
        if (document.getElementById("selecTypeSearch").checkValidity()){
          document.getElementById("selecTypeSearch").setAttribute("class", "custom-select");
          let list = document.getElementById('signatureList');
          list.innerHTML="";
          axios.post('https://pss2020api.herokuapp.com/api/materia/search',
          {
            "search": document.getElementById('searchValue').value,
          }
          ).then(function (response) {
            console.log(response);
            if(response.status == 200){
              let data = response.data.materias;
              var filter;
              if (selecTypeSearch.value == "name")
                filter = 'nombre';
              else
                filter = 'identificador';
              let counter = filterBy(data, filter);
              updateCardFooter(counter);
            }
          })
        } else {
            document.getElementById("selecTypeSearch").setAttribute("class", "custom-select is-invalid");
          }
      });

      function filterBy(data, type) {
        let searchValue = document.getElementById('searchValue').value;
        var counter = 0;
        data.forEach( item => {
          if (item[type].includes(searchValue)) {
            document.getElementById('signatureList').appendChild(createItem(item));
            counter++;
          }
        })
        return counter;
      }

      function updateCardFooter(counter) {
          const footer = document.getElementById("footer");
          var footerText;
          if (counter==0)
            footerText = "No hay resultados";
          else
            if (counter==1)
              footerText = "Se encontr贸 " + counter + " resultado";
            else
              footerText = "Se encontraron " + counter + " resultados";
          footer.innerHTML = footerText;
      }

    </script>
  </body>
</html>
