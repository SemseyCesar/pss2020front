<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
  <head>
    <meta charset="utf-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">



    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,600" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <!-- Button icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
      }
      input[type="number"] {
          -moz-appearance: textfield;
      }
    </style>

  </head>
  <body>
    <div class="container mt-4 mb-4">
      <div class="card">
        <!-- Card header -->
        <div class="card-header h2">
          Buscar Usuarios
        </div>

        <!-- Card body  -->
        <div class="card-body">

              <div class="row mb-4 justify-content-center">

                  <div class="col">
                    <select class="custom-select" name="selecTypeSearch" id="selecTypeSearch" required>
                      <option value="">Buscar por...</option>
                      <option value="dni">DNI</option>
                        <option value="lu">LU</option>
                        <option value="name">Nombre y apellido</option>
                    </select>
                    <div class="invalid-feedback">
                      Seleccione una opción.
                    </div>
                  </div>
                  
                  <div class="col-md">
                    <input class="form-control" type="text" name="searchValue" id="searchValue" placeholder="Seleccione una opción">
                    <div class="invalid-feedback">
                      Las opciones DNI/LU requieren un valor numérico.
                    </div>
                  </div>
                  
                  <div class="col">
                    <button class="btn btn-primary" id="btnBuscar" name="search">
                      <i class="fa fa-search"></i>
                      Buscar
                    </button>
                  </div>

                  <div class="col">
                    <button class="btn btn-success" id="btnAgregarCarrera" name="add">
                      <i class="fa fa-plus"></i>
                      Agregar carrera
                    </button>
                  </div>
                  
              </div>

              <div class="row">
                <table class="table">
                  <thead class="thead-light">
                    <tr>       
                      <th scope="col">Lu</th>
                      <th scope="col">DNI</th>
                      <th scope="col">Nombre y Apellido</th>
                      <th scope="col">Rol</th>
                      <th scope="col">Modificar</th>
                      <th scope="col">Eliminar</th>
                    </tr>
                  </thead>
                  <tbody id="usersList">
                  </tbody>
                </table>
            </div>
      </div>

      <div class="card-footer text-right">
        <b id="footer"></b>
      </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      const selectElement = document.getElementById('selecTypeSearch');
      selectElement.addEventListener('change', (event) => {
        const searchText = document.getElementById('searchValue');
        document.getElementById("selecTypeSearch").setAttribute("class", "custom-select");
        // Reseteo el valor de validez en caso de que el text field estuviera en estado inválido
        searchText.setAttribute("class", "form-control");
        if (event.target.value == "name") {
          searchText.placeholder = `Ingrese el nombre y apellido`;
          searchText.type = "text";
        }
        else {
          searchText.type = "number";
          if (event.target.value == "lu") {
            searchText.placeholder = `Ingrese el L.U.`;
          } else {
            if (event.target.value == "dni") {
              searchText.placeholder = `Ingrese el DNI`;
            } else {
              searchText.placeholder = "Seleccione una opción";
              document.getElementById("selecTypeSearch").setAttribute("class", "custom-select is-invalid");
            }
          }
        }
      });

      function createItem(data){
        let fila = document.createElement("tr");
        let celda_lu = document.createElement("td");
        let celda_dni = document.createElement("td");
        let celda_nombre = document.createElement("td");
        let celda_rol = document.createElement("td");
        let celda_boton_modificar = document.createElement("td");
        let celda_boton_borrar = document.createElement("td");
        
        let boton_modificar = document.createElement("button");
        let boton_borrar = document.createElement("button");
        let icon_modificar = document.createElement("i");
        let icon_borrar = document.createElement("i");
        icon_modificar.setAttribute("class", "fa fa-edit");
        icon_borrar.setAttribute("class", "fa fa-trash");
        boton_modificar.setAttribute("class", "btn btn-outline-warning");
        boton_modificar.setAttribute("id", ""+data['identificador']);
        boton_modificar.addEventListener('click', (event) => {
          document.getElementById('footer').innerHTML = event.target.id;
        })
        boton_borrar.setAttribute("class", "btn btn-outline-danger");
        boton_modificar.appendChild(icon_modificar);
        boton_borrar.appendChild(icon_borrar);

        celda_lu.appendChild(document.createTextNode(""+data['legajo']));
        celda_dni.appendChild(document.createTextNode(""+data['DNI']));
        celda_nombre.appendChild(document.createTextNode(""+data['nombre_apellido']));
        celda_rol.appendChild(document.createTextNode(""+data['type']));
        celda_boton_modificar.appendChild(boton_modificar);
        celda_boton_borrar.appendChild(boton_borrar);

        fila.appendChild(celda_lu);
        fila.appendChild(celda_dni);
        fila.appendChild(celda_nombre);
        fila.appendChild(celda_rol);
        fila.appendChild(celda_boton_modificar);
        fila.appendChild(celda_boton_borrar);

        return fila;
      }


      let btnBuscar = document.getElementById('btnBuscar');
      btnBuscar.addEventListener('click', (event) => {
        // Si se seleccionó una de las opciones de búsqueda, procedo
        if (document.getElementById("selecTypeSearch").checkValidity()){
          // Reseteo el campo de opciones a válido
          document.getElementById("selecTypeSearch").setAttribute("class", "custom-select");

          let searchValue = document.getElementById('searchValue');
          // Como hay dos tipos posibles de ingreso, texto para el nombre o número para dni/lu, controlo el tipo
          if (searchValue.checkValidity()) {
            // Si valida, se resetea sacando el valor de is-invalid
            searchValue.setAttribute("class", "form-control");
            let list = document.getElementById('usersList');
            list.innerHTML="";
            axios.post('https://pss2020api.herokuapp.com/api/user/search',
              {
                "search": searchValue.value,
              }
              ).then(function (response) {
                console.log(response);
                if(response.status == 200){
                  let data = response.data.users;
                  var filter;
                  if (selecTypeSearch.value == "name")
                    filter = 'nombre_apellido';
                  else
                    if (selecTypeSearch.value == "lu")
                      filter = 'legajo';
                    else
                      filter = 'DNI';
                  let counter = filterBy(data, filter);
                  updateCardFooter(counter);
                }
              })
            }
            // Si no valida el tipo de dato, se marca el error
            else {
              searchValue.setAttribute("class", "form-control is-invalid");
            }
        }
        // Si no se seleccionó ninguna opción de búsqueda, se marca el error 
        else {
            document.getElementById("selecTypeSearch").setAttribute("class", "custom-select is-invalid");
          }
      });

      function filterBy(data, type) {
        let searchValue = document.getElementById('searchValue').value;
        var counter = 0;
        data.forEach( item => {
          if (item[type].includes(searchValue)) {
            document.getElementById('usersList').appendChild(createItem(item));
            counter++;
          }
        })
        return counter;
      }

      function updateCardFooter(counter) {
          const footer = document.getElementById("footer");
          var footerText;
          if (counter==0)
            footerText = "No hay resultados";
          else
            if (counter==1)
              footerText = "Se encontró " + counter + " resultado";
            else
              footerText = "Se encontraron " + counter + " resultados";
          footer.innerHTML = footerText;
      }

    </script>
  </body>
</html>
